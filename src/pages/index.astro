---
import "../styles/global.css";
import { modules, sections } from "../data/modules";

const sectionColourMap: Record<number, string> = {
  1: "#284c6f",
  2: "#64a5bf",
  3: "#c14955",
};

const sectionModuleCounts = sections.map((s) => ({
  ...s,
  count: modules.filter((m) => m.section === s.n).length,
}));
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Whole Brand Academy — Course Dashboard</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet">
  </head>
  <body class="bg-[#f7f6f4] min-h-screen">
    <!-- Header -->
    <header class="relative bg-wba-deep text-white py-10 px-4 overflow-hidden">
      <div class="absolute inset-0 bg-gradient-to-br from-white/[0.04] to-transparent"></div>
      <div class="relative max-w-5xl mx-auto flex flex-col md:flex-row items-center gap-4 md:gap-8">
        <img src="/logos/wba-logo-draft.svg" alt="Whole Brand Academy" class="h-14 brightness-0 invert" />
        <div class="text-center md:text-left">
          <p class="text-wba-canvas mt-1 text-base md:text-xl font-medium leading-snug">Build brands people feel before they can explain — and act on.</p>
        </div>
      </div>
    </header>

    <main class="max-w-5xl mx-auto px-4 py-10">
      <!-- Overall progress -->
      <section class="bg-white rounded-xl shadow-sm p-6 mb-12">
        <div class="flex items-center justify-between mb-3">
          <h2 class="font-bold text-wba-deep text-lg">Your Progress</h2>
          <span id="progress-label" class="text-sm font-medium text-wba-blue">0 of 20 modules complete</span>
        </div>
        <div class="w-full bg-wba-canvas rounded-full h-3 overflow-hidden">
          <div id="progress-bar" class="h-3 rounded-full transition-all duration-500" style="width: 2%; min-width: 12px; background: linear-gradient(90deg, #64a5bf, #4d8fa8);"></div>
        </div>
        <div class="flex items-center justify-between mt-2">
          <p id="progress-empty" class="text-sm text-wba-blue font-medium">
            <a href="/lessons/module-1" class="hover:text-wba-teal transition-colors">Start with Lesson 1 →</a>
          </p>
          <p id="progress-pct" class="text-xs text-gray-400">0% complete</p>
        </div>
      </section>

      <!-- Section cards -->
      <section class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-12">
        {sectionModuleCounts.map((section) => {
          const colour = sectionColourMap[section.n];
          return (
            <div
              class="bg-white rounded-xl shadow-sm border-l-4 p-5"
              style={`border-color: ${colour}`}
              data-section={section.n}
            >
              <p class="text-[10px] font-semibold uppercase tracking-[0.15em] text-gray-400 mb-1">Section {section.n}</p>
              <h3 class="font-bold text-wba-deep text-lg mb-3">{section.title}</h3>
              <div class="flex flex-col sm:flex-row sm:items-end sm:justify-between gap-2">
                <span class="text-sm text-gray-500">
                  <span class="section-complete font-bold text-wba-deep text-xl" data-section={section.n}>0</span>
                  <span> / {section.count} modules</span>
                </span>
                <div class="w-full sm:w-20 bg-wba-canvas rounded-full h-2 overflow-hidden">
                  <div
                    class="section-bar h-2 rounded-full transition-all duration-500"
                    data-section={section.n}
                    data-total={section.count}
                    style="width: 0%; min-width: 4px;"
                  ></div>
                </div>
              </div>
            </div>
          );
        })}
      </section>

      <!-- Module grid -->
      <section>
        <h2 class="text-xl font-bold text-wba-deep mb-6">All Modules</h2>

        {sections.map((section) => {
          const sectionMods = modules.filter((m) => m.section === section.n);
          const colour = sectionColourMap[section.n];
          return (
            <div class="mb-12">
              <div class="flex items-center gap-3 mb-5">
                <span
                  class="text-[10px] font-semibold uppercase tracking-[0.15em] px-2.5 py-1 rounded-full text-white"
                  style={`background-color: ${colour}`}
                >
                  Section {section.n}
                </span>
                <h3 class="font-semibold text-wba-deep">{section.title}</h3>
              </div>
              <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                {sectionMods.map((mod) => (
                  <a
                    href={`/lessons/${mod.slug}`}
                    data-module={mod.n}
                    data-section={mod.section}
                    class="module-card group relative bg-white rounded-xl shadow-sm hover:shadow-lg border border-gray-100 hover:border-gray-200 transition-all duration-200 hover:-translate-y-0.5 p-5 pt-7 flex flex-col overflow-hidden"
                  >
                    {/* Coloured top strip */}
                    <div class="absolute top-0 left-0 right-0 h-[3px]" style={`background-color: ${colour}`}></div>
                    {/* Number badge - top left */}
                    <span
                      class="module-num-badge absolute top-3 left-3 flex items-center justify-center w-6 h-6 rounded-full text-[10px] font-bold text-white"
                      style={`background-color: ${colour}`}
                    >
                      {mod.n}
                    </span>
                    <div class="mt-3">
                      <p class="text-sm font-medium text-wba-deep leading-tight group-hover:text-wba-blue transition-colors">
                        {mod.title}
                      </p>
                      <p class="text-sm text-gray-500 mt-1.5 line-clamp-2">{mod.desc}</p>
                    </div>
                    {/* Arrow on hover */}
                    <span class="mt-auto pt-3 text-wba-teal text-sm opacity-0 group-hover:opacity-100 transition-opacity duration-200 self-end">→</span>
                    {/* Completion tick */}
                    <div class="module-tick absolute top-3 right-3 hidden text-wba-teal">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                        <polyline points="20 6 9 17 4 12"/>
                      </svg>
                    </div>
                  </a>
                ))}
              </div>
            </div>
          );
        })}
      </section>
    </main>

    <!-- Footer -->
    <footer class="bg-wba-deep text-white py-8 px-4 mt-8">
      <div class="max-w-5xl mx-auto flex flex-wrap items-center gap-4">
        <img src="/logos/wba-logo-draft.svg" alt="Whole Brand Academy" class="h-8 brightness-0 invert opacity-70 shrink-0" />
        <p class="text-white/50 text-xs sm:text-sm">Building indispensable brands.</p>
      </div>
    </footer>

    <script>
      const STORAGE_KEY = "wba_progress";

      function getProgress(): number[] {
        try {
          return JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
        } catch {
          return [];
        }
      }

      function updateDashboard() {
        const progress = getProgress();
        const total = 20;
        const count = progress.length;
        const pct = Math.round((count / total) * 100);

        const label = document.getElementById("progress-label");
        const bar = document.getElementById("progress-bar");
        const pctEl = document.getElementById("progress-pct");
        const emptyEl = document.getElementById("progress-empty");

        if (label) label.textContent = `${count} of ${total} modules complete`;
        if (bar) {
          const barWidth = count === 0 ? 2 : pct;
          bar.style.width = `${barWidth}%`;
        }
        if (pctEl) pctEl.textContent = `${pct}% complete`;

        // Empty state
        if (emptyEl) {
          if (count === 0) {
            emptyEl.classList.remove("hidden");
          } else {
            emptyEl.classList.add("hidden");
          }
        }

        // Update section bars
        const sectionColours: Record<number, string> = {
          1: "#284c6f",
          2: "#64a5bf",
          3: "#c14955",
        };

        [1, 2, 3].forEach((sectionNum) => {
          const sectionMods: Record<number, number[]> = {
            1: [1, 2, 3, 4, 5, 6],
            2: [7, 8, 9, 10, 11],
            3: [12, 13, 14, 15, 16, 17, 18, 19, 20],
          };
          const mods = sectionMods[sectionNum];
          const done = mods.filter((n) => progress.includes(n)).length;
          const total = mods.length;

          const completeEl = document.querySelector(`.section-complete[data-section="${sectionNum}"]`);
          const barEl = document.querySelector(`.section-bar[data-section="${sectionNum}"]`) as HTMLElement | null;

          if (completeEl) completeEl.textContent = String(done);
          if (barEl) {
            const barPct = done === 0 ? 0 : Math.round((done / total) * 100);
            barEl.style.width = `${barPct}%`;
            barEl.style.backgroundColor = sectionColours[sectionNum];
          }
        });

        // Update module card ticks
        const cards = document.querySelectorAll(".module-card");
        cards.forEach((card) => {
          const modNum = parseInt(card.getAttribute("data-module") || "0");
          const tick = card.querySelector(".module-tick");
          const numBadge = card.querySelector(".module-num-badge") as HTMLElement | null;
          if (progress.includes(modNum)) {
            tick?.classList.remove("hidden");
            if (numBadge) {
              numBadge.style.backgroundColor = "#64a5bf";
            }
          } else {
            tick?.classList.add("hidden");
          }
        });
      }

      window.addEventListener("storage", updateDashboard);
      updateDashboard();
    </script>
  </body>
</html>
